{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Service Jobs</title>
{% endblock meta %}

{% block content %}
<body class="bg-gradient-to-br from-gray-100 to-pink-200 flex justify-center items-center min-h-screen flex-col relative">

  <!-- Large Pink Gradient Block with Service Jobs Text -->
  <div class="absolute top-0 left-0 right-0 bg-gradient-to-br from-pink-500 to-purple-500 p-16 text-white shadow-lg text-center h-72 flex items-center justify-center z-10">
      <h1 class="text-6xl font-bold">Service Jobs</h1>
  </div>

  <div class="container mx-auto p-4 mt-72">
      <!-- Filter Form -->
      <div class="flex justify-center mb-8">
          <form method="get" class="flex items-center space-x-2 bg-white p-4 rounded-md shadow-md" id="filterForm">
              <select name="category" id="category" class="w-[180px] bg-white text-black border-none">
                  <option value="All" {% if selected_category == "All" %}selected{% endif %}>Select Categories</option>
                  {% for category_id, category_name in worker_service_categories %}
                      <option value="{{ category_id }}" {% if selected_category == category_id %}selected{% endif %}>{{ category_name }}</option>
                  {% endfor %}
              </select>
              <select name="subcategory" id="subcategory" class="w-[180px] bg-white text-black border-none" {% if not selected_category or selected_category == "All" %}disabled{% endif %}>
                  <option value="All" {% if selected_subcategory == "All" %}selected{% endif %}>Select Subcategories</option>
                  {% for sub_id, sub_name, cat_id in subcategories %}
                      {% if not selected_category or selected_category == "All" or cat_id == selected_category %}
                          <option value="{{ sub_id }}" {% if selected_subcategory == sub_id %}selected{% endif %}>{{ sub_name }}</option>
                      {% endif %}
                  {% endfor %}
              </select>
              <button type="submit" class="bg-pink-500 hover:bg-pink-600 text-white border-none px-4 py-2 rounded-md">Filter</button>
          </form>
      </div>

      <main class="container mx-auto px-4 py-8">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {% for order in orders %}
                  <div class="bg-white border-none rounded-lg p-4">
                      <h2 class="text-lg font-bold text-pink-600">Order ID: {{ order.0 }}</h2>
                      <p class="text-sm mb-2"><strong>Order Date:</strong> {{ order.3 }}</p>
                      <p class="text-sm mb-2"><strong>Total Price:</strong> ${{ order.4 }}</p>
                      <p class="text-sm mb-2"><strong>Service Time:</strong> {{ order.5 }}</p>
                      <p class="text-sm mb-4"><strong>Subcategory:</strong> {{ order.8 }}</p>
                      <div class="inline-block px-2 py-1 rounded-full text-xs font-bold
                          {% if order.7 == 'Looking for Nearby Worker' %}bg-pink-500 text-white
                          {% else %}bg-blue-500 text-white
                          {% endif %}">
                          {{ order.7 }}
                      </div>
                      {% if order.7 == 'Looking for Nearby Worker' %}
                          <button
                              class="w-full font-semibold bg-pink-600 hover:bg-pink-700 text-white mt-4 py-2 rounded-md"
                              onclick="acceptJob('{{ order.0 }}')"
                          >
                              Accept Job
                          </button>
                      {% else %}
                          <div class="w-full font-semibold bg-white text-pink-800 mt-4 py-2 rounded-md text-center border border-pink-100">
                              Unavailable
                          </div>
                      {% endif %}
                  </div>
              {% endfor %}
          </div>
      </main>
  </div>

  <script>
      document.addEventListener('DOMContentLoaded', function() {
          const categorySelect = document.getElementById('category');
          const subcategorySelect = document.getElementById('subcategory');

          // Event listener for category change
          categorySelect.addEventListener('change', function() {
              const category = this.value;

              if (category === 'All') {
                  subcategorySelect.innerHTML = '<option value="All">All Subcategories</option>';
                  subcategorySelect.disabled = true;
              } else {
                  // Fetch subcategories based on selected category
                  fetch(`?category=${category}`, {
                      method: 'GET',
                      headers: {
                          'X-Requested-With': 'XMLHttpRequest'
                      }
                  })
                  .then(response => response.text())
                  .then(html => {
                      const parser = new DOMParser();
                      const doc = parser.parseFromString(html, 'text/html');
                      const newSubcategorySelect = doc.getElementById('subcategory');
                      subcategorySelect.innerHTML = newSubcategorySelect.innerHTML;
                      subcategorySelect.disabled = false;
                  })
                  .catch(error => console.error('Error:', error));
              }
          });

          // Pre-set the subcategory dropdown based on initial selected category
          if (categorySelect.value && categorySelect.value !== 'All') {
              categorySelect.dispatchEvent(new Event('change'));
          }
      });

      function acceptJob(orderId) {
          fetch("{% url 'accept_job' %}", {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}',
              },
              body: JSON.stringify({ order_id: orderId }),
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert(data.message);
                  location.reload();
              } else {
                  alert('Error: ' + data.message);
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('Something went wrong!');
          });
      }
  </script>
</body>
{% endblock %}
